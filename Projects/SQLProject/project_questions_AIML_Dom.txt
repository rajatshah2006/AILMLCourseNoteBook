Question 1:
Find the total number of customers who have placed orders. What is the distribution of the customers across states? [4 marks]
Hint: For each state, count the number of customers


SELECT 
	state, 
	COUNT(customer_id) AS total_customers
FROM customer_t
GROUP BY 1
ORDER BY 2 DESC;

Question 2:
Which are the top 5 vehicle makers preferred by the customers? [4 marks]
Hint: For each vehicle make what is the count of the customers.

SELECT 
	vehicle_maker AS top_vehicle_makers, 
	COUNT(customer_id) AS total_customers
FROM product_T JOIN customer_t
GROUP BY 1
ORDER BY 2 DESC
LIMIT 5;

Question 3:
Which is the most preferred vehicle maker in each state? [4 marks]
Hint: Use the window function RANK() to rank based on the count of customers for each state and vehicle maker. 
After ranking, take the vehicle maker whose rank is 1.

SELECT *
FROM
(
	SELECT 
		state, 
		vehicle_maker,
		COUNT(customer_id) AS total_customers,
    RANK() OVER (PARTITION BY state ORDER BY COUNT(customer_id) DESC) AS ranking
    FROM product_t 
    JOIN order_t USING(product_id)
    JOIN customer_t USING(customer_id)
	GROUP BY 1, 2 
) AS preferred_vehicle
WHERE ranking = 1
ORDER BY 3 DESC;

Question 4:
Find the overall average rating given by the customers. What is the average rating in each quarter? [5 marks]
Consider the following mapping for ratings:
“Very Bad”: 1, “Bad”: 2, “Okay”: 3, “Good”: 4, “Very Good”: 5
Hint: Use subquery and assign numerical values to feedback categories using a CASE statement. 
Then, calculate the average feedback count per quarter. Use a subquery to convert feedback 
into numerical values and group by quarter_number to compute the average.

WITH rating AS 
(
	SELECT
		customer_feedback,
		quarter_number,
    CASE
		WHEN customer_feedback = 'very bad' THEN '1'
		WHEN customer_feedback = 'bad' THEN '2'
		WHEN customer_feedback = 'okay' THEN '3'
		WHEN customer_feedback = 'good' THEN '4'
		WHEN customer_feedback = 'very good' THEN '5'
    END AS total_rating
    FROM order_t
)
    
SELECT 
		quarter_number,
    ROUND(AVG(total_rating), 2) AS average_rating
FROM rating
GROUP BY 1 
ORDER BY 1 ASC;


Question 5:
Find the percentage distribution of feedback from the customers. Are customers getting more dissatisfied over time? [5 marks]
Hint: Calculate the percentage of each feedback type by using conditional aggregation. 
For each feedback category, use a CASE statement to count the occurrences and then divide by the total count of feedback for the quarter, multiplied by 100 to get the percentage. 
Finally, group by quarter_number and order the results to reflect the correct sequence.

WITH cust_feed AS 
(
	SELECT 
		quarter_number,
		ROUND(SUM(CASE WHEN customer_feedback = 'very good' THEN 1 ELSE 0 END), 2) AS very_good,
		ROUND(SUM(CASE WHEN customer_feedback = 'good' THEN 1 ELSE 0 END), 2) AS good,
		ROUND(SUM(CASE WHEN customer_feedback = 'okay' THEN 1 ELSE 0 END), 2) AS okay,
		ROUND(SUM(CASE WHEN customer_feedback = 'bad' THEN 1 ELSE 0 END), 2) AS bad,
		ROUND(SUM(CASE WHEN customer_feedback = 'very bad' THEN 1 ELSE 0 END), 2) AS very_bad,
		ROUND(COUNT(customer_feedback), 2) AS total_feedback
	FROM order_t
	GROUP BY 1
    ORDER BY 1 ASC
)
   
  SELECT 
		quarter_number,
        ROUND((very_good/total_feedback), 2) AS very_good,
        ROUND((good/total_feedback), 2) AS good,
        ROUND((okay/total_feedback), 2) AS okay,
        ROUND((bad/total_feedback), 2) AS bad,
        ROUND((very_bad/total_feedback), 2) AS very_bad
	FROM cust_feed
	GROUP BY 1
    ORDER BY 1 ASC;


Question 6:
What is the trend of the number of orders by quarter? [3 marks]
Hint: Count the number of orders for each quarter.

SELECT 
	quarter_number,
	COUNT(order_id) AS total_orders
FROM order_t
GROUP BY 1
ORDER BY 1;


Question 7:
Calculate the net revenue generated by the company. What is the quarter-over-quarter % change in net revenue? [5 marks]
Hint: Net Revenue is the amount obtained by multiplying the number of units sold by the price after deducting the discounts applied.
Quarter over Quarter percentage change in revenue means what is the change in revenue from the subsequent quarter to the previous quarter in percentage.
Calculate the revenue for each quarter by summing the quantity of product and the discounted vehicle price. Use the LAG function to get the revenue from the previous quarter, and then compute the quarter-over-quarter percentage change based on the current and previous revenue values.
Ensure the results are ordered by quarter_number to maintain the correct sequence.

 WITH QoQ AS 
(
	SELECT quarter_number, 
        ROUND(SUM(quantity * (vehicle_price - ((discount/100)*vehicle_price))), 0) AS revenue
	FROM order_t
	GROUP BY quarter_number)
SELECT quarter_number, revenue,
ROUND(LAG(revenue) OVER(ORDER BY quarter_number), 2) AS previous_revenue,
ROUND((revenue - LAG(revenue) OVER(ORDER BY quarter_number))/LAG(revenue) OVER(ORDER BY quarter_number), 2) AS qoq_perc_change
FROM QoQ;


Question 8:
What is the trend of net revenue and orders by quarters? [4 marks]
Hint: Find out the sum of net revenue and count the number of orders for each quarter.


SELECT 
	quarter_number,
	ROUND(SUM(quantity*vehicle_price), 0) AS revenue,
    COUNT(order_id) AS total_order
FROM order_t
GROUP BY 1
ORDER BY 1;

Question 9:
What is the average discount offered for different types of credit cards? [3 marks]
Hint: Find out the average of discount for each credit card type.

SELECT 
	credit_card_type,
	ROUND(AVG(discount), 2) AS average_discount
FROM order_t t1
INNER JOIN customer_t t2
 ON t1.customer_id = t2.customer_id
GROUP BY 1
ORDER BY 2 DESC;


Question 10:
What is the average time taken to ship the placed orders for each quarter? [3 marks]


SELECT 
	quarter_number,
    ROUND(AVG(DATEDIFF(ship_date, order_date)), 0) AS average_shipping_time
FROM order_t
GROUP BY 1
ORDER BY 1;